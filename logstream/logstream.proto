syntax = "proto3";
package api.public.logstream;
option go_package = "./logstream";

import "google/api/annotations.proto";

import "manifest.proto";
import "delta.proto";

message StreamLogRequest {
  string build_id = 1;
  repeated Delta deltas = 2;
  bool eof = 3;
}

message StreamLogResponse {
  bool eof_ack = 1;
}

message GetFirebaseAuthTokenRequest {
  // build_id is the id of the build the token is attempting to access.
  // If the build is public the corresponding token will have access to the build.
  // If the build is not public the token will not have access to the build.
  string build_id = 1;
}

message GetFirebaseAuthTokenResponse {
  string token = 1;
}

message LongTermExistsRequest {
  string build_id = 1;
}

message LongTermExistsResponse {
  bool exists = 1;
}

message GetLongTermRequest {
  string build_id = 1;
}

// How the logs are represented in longterm storage
message FormattedLogList {
  repeated DeltaFormattedLog logs = 1;
}

message GetLongTermResponse {
  RunManifest manifest = 1;
  repeated DeltaFormattedLog formatted_logs = 2;
}

message InitLogsRequest {
  RunManifest manifest = 1;
  repeated DeltaFormattedLog formatted_logs = 2;
}

message InitLogsResponse {}

message GetLogsRequest {
  string build_id = 1;
}

message GetLogsResponse {
  RunManifest manifest = 1;
  repeated DeltaFormattedLog formatted_logs = 2;
}

service LogStream {
  // StreamLogs streams logs to the server. Stream protocol:
  // 1. The client opens the channel.
  // 2. The client sends a ResetFields delta.
  // 3. Client continues streaming through the rest of the deltas.
  // 4. The final stream message from the client is an eof=true message.
  // 5. Server responds with eof_ack=true.
  // 6. Client closes the channel. (optionally, the client can wait for server_exit_status)
  rpc StreamLogs(stream StreamLogRequest) returns (stream StreamLogResponse) {}

  rpc GetLogs(GetLogsRequest) returns (GetLogsResponse) {}

  // InitLogs can be used to set the status of a build before or after the core
  // build task is run by the CLI. It's primarily meant to be used by the
  // initialization process, but can also be used to surface errors that may not
  // be handled well by the CLI.
  rpc InitLogs(InitLogsRequest) returns (InitLogsResponse) {}

  // GetFirebaseAuthToken returns a token suitable for use with Firebase APIs
  // The user must already be authenticated.
  rpc GetFirebaseAuthToken(GetFirebaseAuthTokenRequest) returns (GetFirebaseAuthTokenResponse) {
    option (google.api.http) = {
      get: "/api/v0/logstream/firebase-auth-token"
    };
  }

  rpc LongTermExists(LongTermExistsRequest) returns (LongTermExistsResponse) {
    option (google.api.http) = {
      get: "/api/v0/logstream/long-term/{build_id}/exists"
    };
  }

  rpc GetLongTerm(GetLongTermRequest) returns (GetLongTermResponse) {
    option (google.api.http) = {
      get: "/api/v0/logstream/long-term/{build_id}"
    };
  }
}
